# Code Mapping: How {username} Gets Its Value

## Quick Answer

The `{username}` variable in the email template gets its value from the `Username` parameter passed to AWS Cognito's `sign_up()` API call.

**In our code:** `Username = email address`

## Exact Code Path

### 1. Registration Endpoint
**File:** `app/api/v1/endpoints/auth.py`  
**Line:** 148-153

```python
cognito_result = subtiter_cognito.register_user(
    email=user_data.email.strip(),      # ← "john@example.com"
    password=user_data.password,
    name=user_data.name,
    subscription_plan="no_plan"
)
```

**What happens:** The user's email is passed to the `register_user()` method.

---

### 2. Cognito Registration Method
**File:** `app/aws_app_stack/subtiter_cognito.py`  
**Line:** 209-212

```python
response = boto3_cognito_client.sign_up(
    ClientId=self.client_id,
    Username=email,                     # ← THIS IS THE KEY LINE!
    Password=password,
    UserAttributes=[
        {'Name': 'email', 'Value': email},
        {'Name': 'name', 'Value': name},
        {'Name': 'custom:subscription_plan', 'Value': subscription_plan},
    ]
)
```

**What happens:** 
- The `email` parameter (e.g., "john@example.com") is passed as `Username` to AWS Cognito
- AWS Cognito stores this as the user's username
- **This `Username` value becomes `{username}` in the email template**

---

### 3. AWS Cognito (Automatic)
**Service:** AWS Cognito User Pool  
**User Pool ID:** `eu-west-1_zm3OfnfeQ`

```
AWS Cognito receives:
  Username: "john@example.com"

AWS Cognito processes:
  1. Generate verification code: "123456"
  2. Load email template from VerificationMessageTemplate
  3. Replace {username} with "john@example.com"
  4. Replace {####} with "123456"
  5. Send email to john@example.com
```

---

### 4. Email Template
**File:** `app/aws_app_stack/cognito_email_verification/user_verification_template/email_template.html`  
**Line:** 179

```html
<a href="https://subtiter.ai/api/v1/auth/confirm-signup/{username}/{####}" class="verify-button">
    Verify Email Address
</a>
```

**Before sending:**
```html
https://subtiter.ai/api/v1/auth/confirm-signup/{username}/{####}
```

**After Cognito processing:**
```html
https://subtiter.ai/api/v1/auth/confirm-signup/john@example.com/123456
```

---

## Variable Mapping Table

| Template Variable | Source | Example Value | Code Location |
|-------------------|--------|---------------|---------------|
| `{username}` | `Username` parameter in `sign_up()` | `john@example.com` | `subtiter_cognito.py:211` |
| `{####}` | Auto-generated by Cognito | `123456` | AWS Cognito (automatic) |

---

## The Critical Line

**File:** `app/aws_app_stack/subtiter_cognito.py`  
**Line:** 211

```python
Username=email,  # ← {username} in email template = this value
```

This single line determines what `{username}` will be in the email template!

---

## Why Email as Username?

From the docstring in `subtiter_cognito.py` line 196:

```python
"""
Register a new user in Cognito User Pool

Args:
    email: User's email address (will be used as username)  ← See this comment!
    password: User's password
    name: User's full name
    subscription_plan: User's subscription plan
"""
```

We use email as username because:
1. **Uniqueness:** Emails are naturally unique
2. **User-friendly:** Users remember their email
3. **Simplicity:** One identifier for everything
4. **Standard practice:** Common pattern in web applications

---

## Complete Example

### Input (Registration Request)
```json
POST /api/v1/auth/register
{
    "email": "john@example.com",
    "password": "SecurePass123!",
    "name": "John Doe"
}
```

### Code Execution
```python
# auth.py line 148
subtiter_cognito.register_user(
    email="john@example.com",  # ← Input
    ...
)

# subtiter_cognito.py line 211
boto3_cognito_client.sign_up(
    Username="john@example.com",  # ← {username} = "john@example.com"
    ...
)
```

### Email Template (Before)
```html
<a href="https://subtiter.ai/api/v1/auth/confirm-signup/{username}/{####}">
```

### Email Sent (After)
```html
<a href="https://subtiter.ai/api/v1/auth/confirm-signup/john@example.com/123456">
```

### User Clicks Link
```
GET /api/v1/auth/confirm-signup/john@example.com/123456
```

---

## Testing

To see this in action:

1. **Register a new user:**
   ```bash
   curl -X POST https://subtiter.ai/api/v1/auth/register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@example.com",
       "password": "TestPass123!",
       "name": "Test User"
     }'
   ```

2. **Check the email inbox for test@example.com**

3. **You'll see:**
   - Link: `https://subtiter.ai/api/v1/auth/confirm-signup/test@example.com/[6-digit-code]`
   - Code: `[6-digit-code]`

---

## Common Questions

### Q: Can I use a different value for {username}?

**A:** Yes! Just change line 211 in `subtiter_cognito.py`:

```python
# Current (email as username)
Username=email,

# Alternative (use name as username)
Username=name,

# Alternative (use custom username)
Username=f"user_{email.split('@')[0]}",
```

But be careful:
- Username must be unique
- Username is used for login
- Changing this affects the entire authentication flow

### Q: What if the email contains special characters?

**A:** AWS Cognito automatically URL-encodes the username in the link. For example:
- Email: `john+test@example.com`
- Link: `https://subtiter.ai/api/v1/auth/confirm-signup/john%2Btest@example.com/123456`

### Q: Can I add more variables to the template?

**A:** AWS Cognito only supports these variables:
- `{username}` - The username from sign_up()
- `{####}` - Verification code (6 digits)
- `{##}` - Temporary password (for admin-created users)

You cannot add custom variables.

---

## Summary

```
user_data.email → subtiter_cognito.register_user(email=...) 
                → sign_up(Username=email) 
                → AWS Cognito replaces {username} with email value
                → Email sent with actual email address in link
```

**The key:** `Username=email` on line 211 of `subtiter_cognito.py`

