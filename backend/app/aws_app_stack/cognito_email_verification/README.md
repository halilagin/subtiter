# AWS Cognito Email Verification

This directory contains all AWS Cognito email verification templates, scripts, and documentation for Klippers.ai user authentication.

## ğŸ“š Documentation Index

### Quick Start
- **[QUICK_START.md](QUICK_START.md)** - Quick reference guide for common tasks
- **[API_ENDPOINTS.md](API_ENDPOINTS.md)** - â­ **API Documentation** - Registration and confirmation endpoints

### Understanding Template Variables
- **[CODE_MAPPING.md](CODE_MAPPING.md)** - How `{username}` gets its value from code
- **[TEMPLATE_VARIABLES.md](TEMPLATE_VARIABLES.md)** - Detailed explanation of template variables
- **[FLOW_DIAGRAM.txt](FLOW_DIAGRAM.txt)** - Visual flow diagram of the entire process

### Template Documentation
- **[user_verification_template/README.md](user_verification_template/README.md)** - Email template documentation

### Changes and Updates
- **[CHANGES_SUMMARY.md](CHANGES_SUMMARY.md)** - Recent updates and new features

## ğŸ“ Directory Structure

```
cognito_email_verification/
â”œâ”€â”€ README.md                          # This file - main index
â”œâ”€â”€ QUICK_START.md                     # Quick reference guide
â”œâ”€â”€ CODE_MAPPING.md                    # How {username} maps to code
â”œâ”€â”€ TEMPLATE_VARIABLES.md              # Template variable details
â”œâ”€â”€ FLOW_DIAGRAM.txt                   # Visual flow diagram
â”œâ”€â”€ scripts/                           # Management scripts
â”‚   â”œâ”€â”€ confirm_user.py               # Confirm user signups
â”‚   â”œâ”€â”€ list_cognito_users.py         # List all users
â”‚   â””â”€â”€ update_template.sh            # Update email template
â””â”€â”€ user_verification_template/       # Email templates
    â”œâ”€â”€ README.md                     # Template documentation
    â”œâ”€â”€ email_template.html           # HTML template (default)
    â”œâ”€â”€ email_template.txt            # Plain text template
    â””â”€â”€ verification_template.json    # Legacy JSON format
```

## ğŸš€ Quick Actions

### Update Email Template (HTML)
```bash
cd scripts
./update_template.sh
```

### Update Email Template (Plain Text)
```bash
cd scripts
./update_template.sh --text
```

### Preview HTML Template
```bash
open user_verification_template/email_template.html
```

### List Cognito Users
```bash
python scripts/list_cognito_users.py
```

### Confirm a User
```bash
python scripts/confirm_user.py
```

## ğŸ”‘ Key Concept: Template Variables

The email template uses two variables that AWS Cognito automatically replaces:

### `{username}` Variable
- **Source:** `Username` parameter in `boto3_cognito_client.sign_up()`
- **Location:** `app/aws_app_stack/klippers_cognito.py` line 211
- **Value:** The user's email address (e.g., `john@example.com`)
- **Code:** `Username=email`

### `{####}` Variable
- **Source:** Auto-generated by AWS Cognito
- **Value:** 6-digit verification code (e.g., `123456`)
- **Generated:** Automatically when user registers

**ğŸ“– For detailed explanation, see [CODE_MAPPING.md](CODE_MAPPING.md)**

## âš™ï¸ Cognito Configuration

- **User Pool ID**: `eu-west-1_zm3OfnfeQ`
- **User Pool Name**: `klippers-user-pool`
- **Client ID**: `4ucvrbiupts4bs4bdt8mstedsm`
- **Client Name**: `klippers-client`
- **Region**: `eu-west-1`
- **Domain**: `example-terraform-hosted-ui`

## ğŸ”— Related Code Files

### Main Application Code
- `app/api/v1/endpoints/auth.py` (line 148) - Registration endpoint
- `app/aws_app_stack/klippers_cognito.py` (line 209) - Cognito integration
- `app/aws_app_stack/cognito_config.py` - Configuration values
- `app/core/auth.py` - Authentication logic

### The Critical Line
**File:** `app/aws_app_stack/klippers_cognito.py` line 211
```python
Username=email,  # â† {username} in email template = this value
```

## ğŸ“§ Email Template Features

### HTML Template (Default)
- Modern, responsive design
- Purple gradient header (#667eea to #764ba2)
- Prominent "Verify Email Address" button
- Styled verification code box
- Feature highlights section
- Mobile-friendly layout
- Email client compatible

### Plain Text Template (Fallback)
- Simple, clean text format
- Works with all email clients
- No styling required

## ğŸ”„ Authentication Flow

```
1. User registers â†’ POST /api/v1/auth/register
2. auth.py calls klippers_cognito.register_user(email=...)
3. klippers_cognito.py calls sign_up(Username=email)
4. AWS Cognito generates code and sends email
5. User clicks link or enters code
6. User is confirmed in Cognito
7. User can log in
```

**ğŸ“– For visual diagram, see [FLOW_DIAGRAM.txt](FLOW_DIAGRAM.txt)**

## ğŸ¨ Customization

### Change Colors
Edit `user_verification_template/email_template.html`:
- Primary: `#667eea` (purple)
- Secondary: `#764ba2` (dark purple)

### Change Text
Edit the HTML file and run:
```bash
cd scripts
./update_template.sh
```

### Change Verification Link
Edit line 179 in `email_template.html`:
```html
<a href="https://klippers.ai/api/v1/auth/confirm-signup/{username}/{####}">
```

**âš ï¸ Important:** Keep `{username}` and `{####}` placeholders intact!

## ğŸ› ï¸ AWS CLI

All operations use the custom AWS CLI wrapper:
```bash
/usr/local/bin/kaws_klippers_cli
```

## ğŸ“Š Token Configuration

- **Access Token**: 1440 minutes (24 hours)
- **Refresh Token**: 30 days
- **Auth Session**: 3 minutes

## ğŸ” Identity Providers

- **COGNITO**: Native authentication
- **Facebook**: OAuth integration
- **Google**: OAuth integration

## ğŸ“ Custom Attributes

- `custom:subscription_plan` - User's subscription tier

## ğŸ“… Last Updated

November 2, 2025

