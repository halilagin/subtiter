# Cognito Email Template Variables

## How `{username}` and `{####}` Work

When a user registers, AWS Cognito automatically replaces template variables in the email before sending it.

## Registration Flow

```
1. User Registration Request
   ↓
2. auth.py calls subtiter_cognito.register_user()
   ↓
3. subtiter_cognito.py calls boto3_cognito_client.sign_up()
   ↓
4. AWS Cognito receives sign_up request with:
   - Username: user@example.com (the email)
   - Password: ********
   - UserAttributes: [email, name, subscription_plan]
   ↓
5. AWS Cognito automatically:
   - Generates verification code (6 digits)
   - Loads email template from VerificationMessageTemplate
   - Replaces {username} with the Username value
   - Replaces {####} with the verification code
   - Sends email to the user
```

## Variable Mapping

### `{username}` Variable

**Source:** The `Username` parameter in `sign_up()` call

```python
# In subtiter_cognito.py line 209-212
response = boto3_cognito_client.sign_up(
    ClientId=self.client_id,
    Username=email,  # ← This becomes {username} in the template
    Password=password,
    UserAttributes=[...]
)
```

**Example:**
- Registration: `email="john@example.com"`
- Cognito receives: `Username="john@example.com"`
- Template has: `https://subtiter.ai/api/v1/auth/confirm-signup/{username}/{####}`
- Email sent: `https://subtiter.ai/api/v1/auth/confirm-signup/john@example.com/123456`

### `{####}` Variable

**Source:** Auto-generated by AWS Cognito (6-digit code)

**Example:**
- Cognito generates: `123456`
- Template has: `Your verification code is: {####}`
- Email sent: `Your verification code is: 123456`

## Code Trace

### 1. Registration Endpoint (`auth.py`)

```python
# Line 148-153
cognito_result = subtiter_cognito.register_user(
    email=user_data.email.strip(),      # e.g., "john@example.com"
    password=user_data.password,
    name=user_data.name,
    subscription_plan="no_plan"
)
```

### 2. Cognito Registration (`subtiter_cognito.py`)

```python
# Line 209-218
response = boto3_cognito_client.sign_up(
    ClientId=self.client_id,
    Username=email,                     # ← {username} = "john@example.com"
    Password=password,
    UserAttributes=[
        {'Name': 'email', 'Value': email},
        {'Name': 'name', 'Value': name},
        {'Name': 'custom:subscription_plan', 'Value': subscription_plan},
    ]
)
```

### 3. AWS Cognito (Automatic)

AWS Cognito internally:
1. Receives `Username="john@example.com"`
2. Generates verification code (e.g., `123456`)
3. Loads email template from User Pool configuration
4. Performs string replacement:
   - `{username}` → `john@example.com`
   - `{####}` → `123456`
5. Sends email to the user's email address

## Email Template Example

### Template (Before Cognito Processing)

```html
<a href="https://subtiter.ai/api/v1/auth/confirm-signup/{username}/{####}">
    Verify Email Address
</a>

<div class="verification-code">{####}</div>
```

### Actual Email Sent (After Cognito Processing)

```html
<a href="https://subtiter.ai/api/v1/auth/confirm-signup/john@example.com/123456">
    Verify Email Address
</a>

<div class="verification-code">123456</div>
```

## Important Notes

1. **Username = Email**: In our implementation, we use the email as the username
   ```python
   Username=email  # Line 211 in subtiter_cognito.py
   ```

2. **Automatic Replacement**: AWS Cognito handles variable replacement automatically - we don't need to do anything

3. **Case Sensitivity**: The variables must be exactly `{username}` and `{####}` (lowercase, with braces)

4. **URL Encoding**: Cognito automatically URL-encodes the username if needed (e.g., for special characters)

5. **Code Format**: The verification code is always 6 digits (e.g., `123456`)

## Verification Endpoint

When the user clicks the link or enters the code, it calls:

```
GET /api/v1/auth/confirm-signup/{username}/{code}
```

Example:
```
GET /api/v1/auth/confirm-signup/john@example.com/123456
```

This endpoint then calls:
```python
subtiter_cognito.confirm_user_signup(email=username, confirmation_code=code)
```

Which calls AWS Cognito's `confirm_sign_up()` API.

## Testing

To test the email template with actual values:

1. Register a new user
2. Check the email inbox
3. The email will show actual values instead of `{username}` and `{####}`

## Related Files

- **Registration**: `app/api/v1/endpoints/auth.py` (line 148)
- **Cognito Client**: `app/aws_app_stack/subtiter_cognito.py` (line 209)
- **Email Template**: `app/aws_app_stack/cognito_email_verification/user_verification_template/email_template.html`
- **Confirmation**: `app/api/v1/endpoints/auth.py` (confirm-signup endpoint)

## AWS Documentation

AWS Cognito automatically replaces these variables:
- `{username}` - The username provided in sign_up()
- `{####}` - The verification code
- `{##}` - Temporary password (for admin-created users)

Reference: [AWS Cognito Message Templates](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pool-settings-message-templates.html)

